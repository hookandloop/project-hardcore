<header class="header is-personalizable top-header">
  <div class="toolbar">
    <div class="title">
      <h1>
        <span class="panel-title">Designer Application</span>
        <span class="panel-subhead">Last saved at <i id="savedTime">8:02am</i></span>
      </h1>
    </div>
    <div class="buttonset">
      <button class="btn js-btn-save-changes" type="button">
        <span>Save</span>
      </button>
    </div>
    {{> includes/header-actionbutton}}
  </div>
</header>

<div class="step-process-container two-column fixed page-container no-scroll show-main" role="main">

  <div class="sidebar">
    <div class="toolbar toolbar-custom toolbar-collapsible phone-visible">
      <div class="title title-wide">Steps to complete</div>
    </div>
    <ul class="tree js-step-list-scroll" data-init="false" id="step-list">

      <li class="js-step is-selected">
        <a class="js-step-link" href="#profile">
          <svg class="step-alert icon-empty-circle icon" focusable="false" aria-hidden="true" role="presentation">
            <use xlink:href="#icon-empty-circle"></use>
          </svg>
          <span class='tree-text'>Profile and Consent - step 1</span>
        </a>
      </li>
      <li class="js-step">
        <a class="js-step-link" href="#resume">
          <svg class="step-alert icon-empty-circle icon" focusable="false" aria-hidden="true" role="presentation">
            <use xlink:href="#icon-empty-circle"></use>
          </svg>
          <span class="tree-text">Resume / CV - steo2</span>
        </a>
      </li>
      <li class="js-step">
        <a class="js-step-link" href="#preferences">
          <svg class="step-alert icon-empty-circle icon" focusable="false" aria-hidden="true" role="presentation">
            <use xlink:href="#icon-empty-circle"></use>
          </svg>
          <span class="tree-text">Preferences - step 3</span>
        </a>
      </li>
      <li class="js-step">
        <a href="#" class="js-step-link" id="myhistory">
          <svg class="step-alert icon-empty-circle icon" focusable="false" aria-hidden="true" role="presentation">
            <use xlink:href="#icon-empty-circle"></use>
          </svg>
          <svg class="icon-tree icon" focusable="false" aria-hidden="true" role="presentation">
            <use xlink:href="#icon-caret-down"></use>
          </svg>
          <span class="tree-text">My History- step 5</span>
        </a>
        <ul class="folder js-step-folder">
          <li class="js-step">
            <a class="js-step-link" href="#myhistory-1">
              <svg class="step-alert icon-empty-circle icon" focusable="false" aria-hidden="true" role="presentation">
                <use xlink:href="#icon-empty-circle"></use>
              </svg>
              <span class="tree-text">2016 - step 5-1</span>
            </a>
          </li>
          <li class="js-step">
            <a class="js-step-link" href="#myhistory-2">
              <svg class="step-alert icon-empty-circle icon" focusable="false" aria-hidden="true" role="presentation">
                <use xlink:href="#icon-empty-circle"></use>
              </svg>
              <span class="tree-text">2015 - step 5-2</span>
            </a>
          </li>
        </ul>
      </li>
      <li class="js-step">
        <a class="js-step-link" href="#talent">
          <svg class="step-alert icon-empty-circle icon" focusable="false" aria-hidden="true" role="presentation">
            <use xlink:href="#icon-empty-circle"></use>
          </svg>
          <span class="tree-text">Talent Profile - step 6</span>
        </a>
      </li>
      <li class="js-step">
        <a class="js-step-link" id="information" href="#">
          <svg class="step-alert icon-empty-circle icon" focusable="false" aria-hidden="true" role="presentation">
            <use xlink:href="#icon-empty-circle"></use>
          </svg>
          <svg class="icon-tree icon" focusable="false" aria-hidden="true" role="presentation">
            <use xlink:href="#icon-caret-down"></use>
          </svg>
          <span class="tree-text">Information - step 7</span>
        </a>
        <ul class="js-step-folder folder">
        </ul>
      </li>
      <li class="js-step">
        <a class="js-step-link" href="#summary">
          <svg class="step-alert icon-empty-circle icon" focusable="false" aria-hidden="true" role="presentation">
            <use xlink:href="#icon-empty-circle"></use>
          </svg>
          <span class="tree-text">Summary - step 8</span>
        </a>
      </li>
      <li class="js-step">
        <a class="js-step-link is-disabled" href="#disabled">
          <svg class="step-alert icon-empty-circle icon" focusable="false" aria-hidden="true" role="presentation">
            <use xlink:href="#icon-empty-circle"></use>
          </svg>
          <svg class="icon-tree icon" focusable="false" aria-hidden="true" role="presentation">
            <use xlink:href="#icon-caret-down"></use>
          </svg>
          <span class="tree-text">Disabled- step 9</span>
        </a>
        <ul class="folder is-open js-step-folder">
          <li class="js-step">
            <a class="js-step-link" href="#disabled-1">
              <svg class="step-alert icon-empty-circle icon" focusable="false" aria-hidden="true" role="presentation">
                <use xlink:href="#icon-empty-circle"></use>
              </svg>
              <span class="tree-text">Old - step 9-1</span>
            </a>
          </li>
          <li class="js-step">
            <a class="js-step-link" href="#disabled-2">
              <svg class="step-alert icon-empty-circle icon" focusable="false" aria-hidden="true" role="presentation">
                <use xlink:href="#icon-empty-circle"></use>
              </svg>
              <span class="tree-text">Older - step 9-2</span>
            </a>
          </li>
        </ul>
      </li>
    </ul>
  </div>

  <div class="main no-scroll" role="main">

    <div class="toolbar toolbar-custom toolbar-collapsible">
      <div class="title">
        <button class="btn-icon btn-toggle-steps js-toggle-sidebar" type="button">
          <svg class="icon" focusable="false" aria-hidden="true" role="presentation">
            <use xlink:href="#icon-bullet-steps"></use>
          </svg>
          <span class="audible">Steps</span>
        </button>
        <div class="dual-title">
          Preferences
          <small>Page X of XX</small>
        </div>
      </div>
      <div class="buttonset phone-hidden">
        <button class="btn-tertiary js-step-link-prev" type="button">
          <span>Previous</span>
        </button>
        <button class="btn-tertiary js-step-link-next" type="button">
          <span>Next</span>
        </button>
      </div>
    </div>

    <div class="scrollable step-container js-step-container-scroll">

      <div id="profile" class="js-step-panel">
        <h2>Profile</h2>
        <form>
          <div class="field">
            <input type="checkbox" class="checkbox" id="vetocheckbox1">
            <label for="vetocheckbox1" class="checkbox-label">Veto Next Step</label>
          </div>
        </form>
      </div>

      <div id="resume" class="js-step-panel">
        <h2>Resume / CV</h2>
        <form>
          <div class="field">
            <label for="slider-competency">How competent do you think you are?</label>
            <input id="slider-competency" name="slider-competency1" class="slider" type="range" min="0" max="4" value="0" step="1" data-ticks='[
              {"value": 0, "description": "0%"},
              {"value": 1, "description": "25%"},
              {"value": 2, "description": "50%"},
              {"value": 3, "description": "75%"},
              {"value": 4, "description": "100%"}
            ]' />
          </div>
        </form>
      </div>

      <div id="preferences" class="js-step-panel">
        <h2>Preferences</h2>
        <form>
          <div class="field">
            <input type="checkbox" class="checkbox" id="addstepcheckbox">
            <label for="addstepcheckbox" class="checkbox-label">Add Another Step</label>
          </div>
        </form>
      </div>

      <div id="myhistory-1" class="js-step-panel">
        <h2>My History Substep 1</h2>
        <p>This is History substep 1</p>
        <form>
          <div class="field">
            <input type="checkbox" class="checkbox" id="vetocheckbox2">
            <label for="vetocheckbox2" class="checkbox-label">Veto Next Sub Step</label>
          </div>
        </form>
      </div>

      <div id="myhistory-2" class="js-step-panel">
        <h2>My History Substep 2</h2>
        <p>This is History substep 2</p>
      </div>

      <div id="talent" class="js-step-panel">
        <h2>Talent</h2>
        <p>This is the Talent Step</p>
      </div>

      <div id="information" class="js-step-panel">
        <h2>Information</h2>
        <p>This is information Step</p>
      </div>

      <div id="summary" class="js-step-panel">
        <h2>Summary</h2>
        <p>This is final Summary Step</p>
      </div>

      <div id="disabled-1" class="js-step-panel">
        <h2>1st disabled step</h2>
        <p>This is a disabled step</p>
      </div>
      <div id="disabled-2" class="js-step-panel">
        <h2>2nd disabled step</h2>
        <p>This is a disabled step</p>
      </div>
    </div>

    <div class="phone-action-bar phone-visible">
      <button class="btn js-btn-save-changes" type="button">Save &amp; Close</button>
      <button class="btn-primary js-step-link-next" type="button">Next</button>
    </div>
  </div>
</div>

<script>
  var instertStep = true;
  var instertSubStep = true;
  $(function() {

    // Init Step Process
    var stepElem = $('.step-process-container').stepprocess({
      'beforeSelectStep': stepFunctions.beforeSelectStep,
      'linearProgression': false
    });

    // Example button save event
    $('.js-btn-save-changes').click(function(e) {
      e.preventDefault();
      $('body').message({
        title: 'Step Saved',
        isError: false,
        returnFocus: $(this),
        message: 'This has been saved.',
        buttons: [{
          text: 'Ok',
          click: function() {
            $(this).data('modal').close();
          },
          isDefault: true
        }]
      });
    });
  });

  // Step Functions
  var stepFunctions = {
    // When a folder opens
    beforeSelectStep: function(args) {

      // We do this because folders don't have an associated content panel
      // as they are just links to open the subfolders.
      var hashLoc = $(args.stepLink).attr('href');

      var stepId;

      if (hashLoc !== '#') {
        stepId = $(args.stepLink).attr('href').substring(1);
      } else {
        stepId = $(args.stepLink).attr('id');
      }

      var deferred = $.Deferred();

      // simulate ajax call
      setTimeout(function()
      {
        var stepLinkToSelect;
        // check to see if first panel is vetoable
        if ($('#vetocheckbox1').is(":checked"))
        {
          alert("cant go to that step");
          deferred.resolve(false);
        }   /// check to see if substep is vetoable
        else
        if ($('#vetocheckbox2').is(":checked"))
        {
          alert("cant go to that substep");
          deferred.resolve(false);
        }
        else
        if ($('#addstepcheckbox').is(":checked") && instertStep)
        {
          instertStep = false;
          var panel = $('#addstepcheckbox').closest(".js-step-panel");
          var panelId = panel.attr("id");
          $('<div id="global" class="js-step-panel"><h2>Global</h2><p>This is Global Step</p></div>"').insertAfter(panel);
          var step = $("[href='#" + panelId + "']").parent();
          stepLinkToSelect = $('<li class="js-step"><a class="js-step-link" href="#global" role="stepitem"><svg class="step-alert icon-empty-circle icon" focusable="false" aria-hidden="true" role="presentation"><use xlink:href="#icon-empty-circle"></use></svg><span class="tree-text">Global - step 4</span></a></li>').insertAfter(step);
        }
        else
        if (stepId == "information" && instertSubStep)
        {
          instertSubStep = false;
          var step = $("#information");
          var substeps = step.parent().find("ul");
          var markup = '<li class="js-step"><a class="js-step-link" href="#information-1" role="stepitem"><svg class="step-alert icon-empty-circle icon" focusable="false" aria-hidden="true" role="presentation"><use xlink:href="#icon-empty-circle"></use></svg><span class="tree-text">Personal - step 7-1</span/a></li>';
          markup += '<li class="js-step"><a class="js-step-link" href="#information-2" role="stepitem"><svg class="step-alert icon-empty-circle icon" focusable="false" aria-hidden="true" role="presentation"><use xlink:href="#icon-empty-circle"></use></svg><span class="tree-text">Family - step 7-2</span/a></li>';
          $(markup).appendTo(substeps);  //.insertAfter(step);

          stepLinkToSelect = $('.js-step-link[href="#information-1"]');

          var panel = $(".step-container");

          $('<div id="information-2" class="js-step-panel"><h2>Global</h2><p>This is Information SubStep2</p></div>"').insertAfter(panel);
          $('<div id="information-1" class="js-step-panel"><h2>Global</h2><p>This is Information SubStep1</p></div>"').insertAfter(panel);
        }
        else
        {
          deferred.resolve(true);
          $(args.stepElem).attr("visited", "true");

          // **** Need to be able to change icon here *****
          //    $(e).attr("data-alert-icon", "confirm");

        }

        if (stepLinkToSelect)
        {
          deferred.resolve(true, stepLinkToSelect);
        } else
        {
          deferred.resolve(true);
        }
      },100);

      return deferred.promise();
    },
  };

</script>
